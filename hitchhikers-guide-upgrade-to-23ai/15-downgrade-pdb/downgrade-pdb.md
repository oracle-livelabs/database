# Downgrade a PDB

## Introduction

In this lab, you will try a database downgrade. After an upgrade, if a serious problem arises in the new release, you can bring the database back to the previous release. This is called a database downgrade.

The PDB, *YELLOW*, has already been upgraded from Oracle Database 19c to 23ai. It's currently placed in *CDB23COM*. You will downgrade *YELLOW** and plug it into the *CDB19* running on Oracle Database 19c.

Estimated Time: 20 minutes

### Objectives

In this lab, you will:

* Downgrade a PDB
* Unplug from Oracle Database 23ai back to 19c

### Prerequisites

None.

This lab uses the *CDB19* databases. Don't do this lab at the same time as lab 10.

## Task 1: Prepare for downgrade

You start the downgrade process while the PDB is still on Oracle Database 23ai.

1. Connect to *CDB23COM*. This CDB currently holds the upgraded PDB.

    ```
    <copy>
    . cdb23com
    sqlplus / as sysdba
    </copy>

    -- Be sure to hit RETURN
    ```

2. Start the CDB.

    ```
    <copy>
    startup
    </copy>
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> startup
    ORACLE instance started.

    Total System Global Area 4292413984 bytes
    Fixed Size                  5368352 bytes
    Variable Size             939524096 bytes
    Database Buffers         3338665984 bytes
    Redo Buffers                8855552 bytes
    Database mounted.
    Database opened.
    ```
    </details>

3. Switch to *YELLOW*.

    ```
    <copy>
    alter session set container=YELLOW;
    </copy>
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> alter session set container=YELLOW;

    Session altered.
    ```
    </details>

4. Verify that the PDB is still on the new release.

    ```
    <copy>
    select version from v$instance;
    </copy>
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> select version from v$instance;

    VERSION_FULL
    -----------------
    23.0.0.0.0
    ```
    </details>

5. Ensure that the `COMPATIBLE` parameter is still set at the old release setting, *19.0.0*.

    ```
    <copy>
    select value from v$parameter where name = 'compatible';
    </copy>
    ```

    * It is a requirement for a downgrade, that you haven't changed the `COMPATIBLE` parameter after the upgrade. The `COMPATIBLE` parameter must remain at the same setting as before the upgrade.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> SELECT value FROM v$parameter WHERE name = 'compatible';

    VALUE
    --------------------------------------------------------------------------------
    19.0.0
    ```
    </details>

6. Switch back to the root container and open the *YELLOW* in *downgrade* mode.

    ```
    <copy>
    alter session set container=CDB$ROOT;
    alter pluggable database yellow close immediate;
    alter pluggable database yellow open downgrade;
    </copy>

    -- Be sure to hit RETURN
    ```

    * *Downgrade* mode is a special mode - similar to *upgrade* mode. It enables exclusive access to the database and disables a lot of features.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> alter session set container=CDB$ROOT;

    Session altered.

    SQL> alter pluggable database yellow close immediate;

    Pluggable database altered.

    SQL> alter pluggable database yellow open downgrade;

    Pluggable database altered.
    ```
    </details>

7. Exit SQL*Plus.

    ```
    <copy>
    exit
    </copy>
    ```

## Task 2: Downgrade the PDB from Oracle Database 23ai

Now that the PDB is open in downgrade mode, you can start the process.

1. Use the `dbdowngrade` script to start the downgrade process. It typically takes a few minutes.

    ```
    <copy>
    cd $ORACLE_HOME/bin
    ./dbdowngrade -c 'YELLOW'
    </copy>

    -- Be sure to hit RETURN
    ```

    * Use `-c` to downgrade just that one PDB, not the entire CDB.
    * Since you didn't specify a logging directory, it will use a default.
    * If you want to monitor the downgrade, you can open a second terminal, go to the logging directory (`/u01/app/oracle/product/23/cfgtoollogs/downgrade`) and tail the log files.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    Downgrading containers
    catcon::set_log_file_base_path: ALL catcon-related output will be written to [/u01/app/oracle/product/23/cfgtoollogs/downgrade/catdwgrd_catcon_123067.lst]

    catcon::set_log_file_base_path: catcon: See [/u01/app/oracle/product/23/cfgtoollogs/downgrade/catdwgrd*.log] files for output generated by scripts

    catcon::set_log_file_base_path: catcon: See [/u01/app/oracle/product/23/cfgtoollogs/downgrade/catdwgrd_*.lst] files for spool files, if any

    catcon.pl: completed successfully
    ```
    </details>

2. Connect to *CDB23COM*.

    ```
    <copy>
    sqlplus / as sysdba
    </copy>
    ```

3. Shut down the PDB and unplug it from the *CDB23COM*.

    ```
    <copy>
    alter pluggable database YELLOW close;
    alter pluggable database YELLOW unplug into '/home/oracle/scripts/yellow.xml';
    </copy>

    -- Be sure to hit RETURN
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> alter pluggable database YELLOW close;

    Pluggable database altered.

    SQL> alter pluggable database YELLOW unplug into '/home/oracle/scripts/yellow.xml';

    Pluggable database altered.
    ```
    </details>

4. Exit SQL*Plus.

    ```
    <copy>
    exit
    </copy>
    ```

## Task 3: Open PDB in Oracle Database 19c

You need to plug the PDB into a CDB on Oracle Database 19c and finish the downgrade process.

1. Set the environment to the *CDB19* and connect.

    ```
    <copy>
    . cdb19
    sqlplus / as sysdba
    </copy>

    -- Be sure to hit RETURN
    ```

2. Start up *CDB19*.

    ```
    <copy>
    startup
    </copy>
    ```

    * The *CDB19* database might be running already. If so, you will get `ORA-01081: cannot start already-running ORACLE - shut it down first`. You can safely ignore the error.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> startup
    ORACLE instance started.

    Total System Global Area 4294964616 bytes
    Fixed Size                  9172360 bytes
    Variable Size             855638016 bytes
    Database Buffers         3422552064 bytes
    Redo Buffers                7602176 bytes

    Database mounted.
    Database opened.
    ```
    </details>

3. Plug in *YELLOW* and open it in *upgrade* mode.

    ```
    <copy>
    create pluggable database YELLOW using '/home/oracle/scripts/yellow.xml';
    alter pluggable database YELLOW open upgrade;
    </copy>

    -- Be sure to hit RETURN
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> create pluggable database YELLOW using '/home/oracle/scripts/yellow.xml';

    Pluggable database created.

    SQL> alter pluggable database YELLOW open upgrade;

    Pluggable database altered.
    ```
    </details>

4. Switch to *YELLOW* and complete the downgrade. The *catrelod.sql* script reloads the appropriate version for each of the database components in the downgraded database.

    ```
    <copy>
    alter session set container=YELLOW;
    @$ORACLE_HOME/rdbms/admin/catrelod.sql
    </copy>

    -- Be sure to hit RETURN
    ```

    * The script takes 10-15 minutes to complete.
    * In the end, you will see a message saying *END catrelod.sql*.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    (output truncated)

    SQL> Rem    SQL_PHASE: MISC
    SQL> Rem    SQL_STARTUP_MODE: NORMAL
    SQL> Rem    SQL_IGNORABLE_ERRORS: NONE
    SQL> Rem    END SQL_FILE_METADATA
    SQL> Rem
    SQL> Rem    MODIFIED   (MM/DD/YY)
    SQL> Rem    surman      05/04/18 - 27464252: Update SQL_PHASE
    SQL> Rem    surman      03/08/13 - 16462837: Common start and end scripts
    SQL> Rem    surman      03/08/13 - Created
    SQL> Rem
    SQL>
    SQL> alter session set "_ORACLE_SCRIPT" = false;

    Session altered.

    SQL>
    SQL>
    SQL>
    SQL> Rem *******************************************************************
    SQL> Rem END catrelod.sql
    SQL> Rem *******************************************************************
    ```
    </details>

5. Recompile all invalid objects. The *utlrp.sql* script recompiles all existing PL/SQL modules that were previously in an *INVALID* state, such as packages, procedures, types, and so on.

    ```
    <copy>
    @$ORACLE_HOME/rdbms/admin/utlrp.sql
    </copy>
    ```

    * It takes a few minutes for the recompilation to complete.
    * In the end, you will see a message saying *END utlrp.sql*.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    (output truncated)

    SQL> SET serveroutput off
    SQL>
    SQL>
    SQL> Rem =====================================================================
    SQL> Rem Run component validation procedure
    SQL> Rem =====================================================================
    SQL>
    SQL> SET serveroutput on
    SQL> EXECUTE dbms_registry_sys.validate_components;

    PL/SQL procedure successfully completed.

    SQL> SET serveroutput off
    SQL>
    SQL>
    SQL> Rem ===========================================================================
    SQL> Rem END utlrp.sql
    SQL> Rem ===========================================================================
    ```
    </details>

6. Restart the PDB.

    ```
    <copy>
    shutdown immediate
    startup
    </copy>

    -- Be sure to hit RETURN
    ```

    * Since your session is connected to *YELLOW*, you can use `shutdown` and `startup` to just restart the PDB, not the entire CDB.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> shutdown immediate

    Pluggable Database closed.

    SQL> startup

    Pluggable Database opened.
    ```
    </details>

7. Ensure that the PDB is open in *READ WRITE* mode and unrestricted.

    ```
    <copy>
    select open_mode, restricted from v$pdbs;
    </copy>
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> select open_mode, restricted from v$pdbs;

    OPEN_MODE  RES
    ---------- ---
    READ WRITE NO

    1 row selected.
    ```
    </details>

8. Check the version of the PDB.

    ```
    <copy>
    select version from v$instance;
    </copy>
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> select version from v$instance;

    VERSION_FULL
    ---------------
    19.21.0.0.0

    1 row selected.
    ```
    </details>

9. Ensure all components have been downgraded and are *VALID* or *OPTION OFF*.

    ```
    <copy>
    select comp_id, version, status from dba_registry;
    </copy>
    ```

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> select comp_id, version, status from dba_registry;

    COMP_ID                        VERSION
    ------------------------------ ------------------------------
    STATUS
    --------------------------------------------
    CATALOG                        19.0.0.0.0
    VALID

    CATPROC                        19.0.0.0.0
    VALID

    RAC                            19.0.0.0.0
    OPTION OFF

    XDB                            19.0.0.0.0
    VALID

    OWM                            19.0.0.0.0
    VALID


    5 rows selected.
    ```
    </details>

10. Gather dictionary and fixed objects statistics.

    ```
    <copy>
    exec dbms_stats.gather_dictionary_stats;
    exec dbms_stats.gather_fixed_objects_stats;
    </copy>

    -- Be sure to hit RETURN
    ```

    * In this lab, you gather fixed objects statistics immediately after the downgrade. In a realistic scenario, you would wait some time until the database is warmed up and in use.

    <details>
    <summary>*click to see the output*</summary>
    ``` text
    SQL> exec dbms_stats.gather_dictionary_stats;

    PL/SQL procedure successfully completed.

    SQL> exec dbms_stats.gather_fixed_objects_stats;

    PL/SQL procedure successfully completed.
    ```
    </details>

11. Exit SQL*Plus.

    ```
    <copy>
    exit
    </copy>
    ```

**Congratulations!** You have now downgraded a PDB from Oracle Database 23ai to 19c.

You may now *proceed to the next lab*.

## Learn More

A downgrade is a very useful fallback option. You can use it even after go-live and move back to the previous release without data loss. However, you can only downgrade to the release from which you originally upgraded.
A downgrade doesn't bring back the old data dictionary, but rather brings the data dictionary into a compatible state that can be used with the old release.
In order to downgrade, it is a requirement that you haven't changed the `COMPATIBLE` parameter since the upgrade. The parameter must have the same value as on the previous release.

* Documentation, [Downgrading a Single Pluggable Oracle Database (PDB)](https://docs.oracle.com/en/database/oracle/oracle-database/23/upgrd/downgrading-oracle-db-after-upgrade.html#GUID-66560D5D-A5C8-4ACC-82C0-46315465E77F)
* Webinar, [Secure Your Job – Fallback Is Your Insurance](https://www.youtube.com/watch?v=P12UqVRzarw)
* Slides, [Secure Your Job – Fallback Is Your Insurance](https://dohdatabase.com/wp-content/uploads/2021/11/emea11_fallback.pdf)

## Acknowledgements
* **Author** - Daniel Overby Hansen
* **Contributors** - Klaus Gronau, Rodrigo Jorge, Alex Zaballa, Mike Dietrich
* **Last Updated By/Date** - Daniel Overby Hansen, June 2024