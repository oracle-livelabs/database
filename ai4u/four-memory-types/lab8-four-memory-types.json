{
  "paragraphs": [
    {
      "text": "%md\n# The Four Types of Agent Memory\n\n## Introduction\n\nIn this lab, you'll build all four types of memory that agents need to operate effectively.\n\nJust like people don't rely on one kind of memory, agents can't either. Agents need:\n\n- **Short-term context** — What's happening right now\n- **Long-term facts** — Stable information about entities\n- **Decisions and outcomes** — What was decided and why\n- **Reference knowledge** — Policies and procedures\n\nYou'll create each type and see how they work together to make agents consistent and explainable.\n\nEstimated Time: 15 minutes\n\n### Objectives\n\n* Create the four types of agent memory\n* Understand when each type is used\n* Store and retrieve from each memory type\n* See how agents coordinate multiple memory types\n\n### Prerequisites\n\nThis lab assumes you have:\n\n* Completed Labs 1-7 or have a working agent setup\n* An AI profile named `genai` already configured\n* Oracle Database 26ai with Select AI Agent\n* Basic knowledge of SQL and JSON\n\n## Task 1: Create the Memory Tables\n\nWe'll create structures for each memory type.\n\n1. Create the unified memory table with type classification.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE TABLE agent_memory (\n    memory_id      RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,\n    memory_type    VARCHAR2(20) NOT NULL,  -- SHORTTERM, LONGTERM, DECISION, REFERENCE\n    session_id     VARCHAR2(100),          -- For short-term context\n    entity_id      VARCHAR2(100),          -- What this is about\n    content        JSON NOT NULL,\n    created_at     TIMESTAMP DEFAULT SYSTIMESTAMP,\n    expires_at     TIMESTAMP,              -- For short-term context expiration\n    CONSTRAINT chk_memory_type CHECK (memory_type IN ('SHORTTERM', 'LONGTERM', 'DECISION', 'REFERENCE'))\n);\n\nCREATE INDEX idx_memory_type ON agent_memory(memory_type);\nCREATE INDEX idx_memory_entity ON agent_memory(entity_id);\nCREATE INDEX idx_memory_session ON agent_memory(session_id);",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Create a separate reference table for policies (read-only by agents).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE TABLE reference_knowledge (\n    ref_id       RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,\n    category     VARCHAR2(100) NOT NULL,\n    name         VARCHAR2(200) NOT NULL,\n    content      JSON NOT NULL,\n    is_active    NUMBER(1) DEFAULT 1,\n    created_at   TIMESTAMP DEFAULT SYSTIMESTAMP,\n    updated_by   VARCHAR2(100)  -- Humans update this, not agents\n);",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n## Task 2: Short-Term Context (Current Task)\n\nShort-term context holds what's happening right now—the active information for completing the current task.\n\n1. Create functions for short-term context.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Store short-term context\nCREATE OR REPLACE FUNCTION set_context(\n    p_session_id  VARCHAR2,\n    p_entity_id   VARCHAR2,\n    p_context     VARCHAR2\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\nBEGIN\n    -- Clear old context for this session/entity\n    DELETE FROM agent_memory \n    WHERE memory_type = 'SHORTTERM' \n    AND session_id = p_session_id \n    AND entity_id = p_entity_id;\n    \n    -- Store new context (expires in 1 hour)\n    INSERT INTO agent_memory (memory_type, session_id, entity_id, content, expires_at)\n    VALUES (\n        'SHORTTERM', \n        p_session_id, \n        p_entity_id,\n        JSON_OBJECT('context' VALUE p_context, 'set_at' VALUE TO_CHAR(SYSTIMESTAMP, 'HH24:MI:SS')),\n        SYSTIMESTAMP + INTERVAL '1' HOUR\n    );\n    COMMIT;\n    RETURN 'Context set for ' || p_entity_id;\nEND;\n/\n\n-- Get short-term context\nCREATE OR REPLACE FUNCTION get_context(\n    p_session_id VARCHAR2,\n    p_entity_id  VARCHAR2 DEFAULT NULL\n) RETURN VARCHAR2 AS\n    v_result CLOB := '';\nBEGIN\n    FOR rec IN (\n        SELECT entity_id, JSON_VALUE(content, '$.context') as context\n        FROM agent_memory\n        WHERE memory_type = 'SHORTTERM'\n        AND session_id = p_session_id\n        AND (p_entity_id IS NULL OR entity_id = p_entity_id)\n        AND (expires_at IS NULL OR expires_at > SYSTIMESTAMP)\n    ) LOOP\n        v_result := v_result || rec.entity_id || ': ' || rec.context || CHR(10);\n    END LOOP;\n    \n    IF v_result IS NULL THEN\n        RETURN 'No active context found.';\n    END IF;\n    RETURN v_result;\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Test short-term context.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Set context for current task\nSELECT set_context('SESSION-001', 'current_customer', 'Acme Corp, Premium tier, discussing order issue') FROM DUAL;\nSELECT set_context('SESSION-001', 'current_order', 'ORD-5678, shipped late, customer needs by Friday') FROM DUAL;\n\n-- Retrieve context\nSELECT get_context('SESSION-001') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n## Task 3: Long-Term Facts (Persistent Entity Knowledge)\n\nLong-term facts are stable information the agent should rely on across tasks and sessions.\n\n1. Create functions for long-term facts.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Store a long-term fact\nCREATE OR REPLACE FUNCTION store_fact(\n    p_entity_id   VARCHAR2,\n    p_fact        VARCHAR2,\n    p_category    VARCHAR2 DEFAULT 'general'\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\nBEGIN\n    INSERT INTO agent_memory (memory_type, entity_id, content)\n    VALUES (\n        'LONGTERM',\n        p_entity_id,\n        JSON_OBJECT(\n            'fact'     VALUE p_fact,\n            'category' VALUE p_category,\n            'learned'  VALUE TO_CHAR(SYSTIMESTAMP, 'YYYY-MM-DD HH24:MI:SS')\n        )\n    );\n    COMMIT;\n    RETURN 'Fact stored about ' || p_entity_id || ': ' || p_fact;\nEND;\n/\n\n-- Retrieve facts about an entity\nCREATE OR REPLACE FUNCTION get_facts(\n    p_entity_id VARCHAR2,\n    p_category  VARCHAR2 DEFAULT NULL\n) RETURN CLOB AS\n    v_result CLOB := '';\n    v_count NUMBER := 0;\nBEGIN\n    FOR rec IN (\n        SELECT \n            JSON_VALUE(content, '$.fact') as fact,\n            JSON_VALUE(content, '$.category') as category\n        FROM agent_memory\n        WHERE memory_type = 'LONGTERM'\n        AND entity_id = p_entity_id\n        AND (p_category IS NULL OR JSON_VALUE(content, '$.category') = p_category)\n        ORDER BY created_at DESC\n    ) LOOP\n        v_result := v_result || '- ' || rec.fact || ' (' || rec.category || ')' || CHR(10);\n        v_count := v_count + 1;\n    END LOOP;\n    \n    IF v_count = 0 THEN\n        RETURN 'No facts found for ' || p_entity_id;\n    END IF;\n    RETURN 'Found ' || v_count || ' facts about ' || p_entity_id || ':' || CHR(10) || v_result;\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Store some long-term facts.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Facts about customers\nSELECT store_fact('CUST-001', 'Prefers email contact over phone', 'preference') FROM DUAL;\nSELECT store_fact('CUST-001', 'Timezone is Pacific', 'preference') FROM DUAL;\nSELECT store_fact('CUST-001', 'Approved for 20% discount exception', 'exception') FROM DUAL;\nSELECT store_fact('CUST-001', 'Primary contact is Sarah Johnson', 'contact') FROM DUAL;\n\nSELECT store_fact('CUST-002', 'Requires PO number on all invoices', 'requirement') FROM DUAL;\nSELECT store_fact('CUST-002', 'Annual contract renewal in March', 'schedule') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. Retrieve facts.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Get all facts about a customer\nSELECT get_facts('CUST-001') FROM DUAL;\n\n-- Get only preferences\nSELECT get_facts('CUST-001', 'preference') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n## Task 4: Decisions and Outcomes (Audit Trail)\n\nDecisions and outcomes record what the agent decided and what happened.\n\n1. Create functions for decisions and outcomes.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Record a decision\nCREATE OR REPLACE FUNCTION record_decision(\n    p_entity_id   VARCHAR2,\n    p_situation   VARCHAR2,\n    p_decision    VARCHAR2,\n    p_outcome     VARCHAR2,\n    p_success     VARCHAR2 DEFAULT 'true'\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\nBEGIN\n    INSERT INTO agent_memory (memory_type, entity_id, content)\n    VALUES (\n        'DECISION',\n        p_entity_id,\n        JSON_OBJECT(\n            'situation' VALUE p_situation,\n            'decision'  VALUE p_decision,\n            'outcome'   VALUE p_outcome,\n            'success'   VALUE (CASE WHEN UPPER(p_success) = 'TRUE' THEN true ELSE false END),\n            'recorded'  VALUE TO_CHAR(SYSTIMESTAMP, 'YYYY-MM-DD HH24:MI:SS')\n        )\n    );\n    COMMIT;\n    RETURN 'Decision recorded: ' || p_decision;\nEND;\n/\n\n-- Find similar past decisions\nCREATE OR REPLACE FUNCTION find_past_decisions(\n    p_situation VARCHAR2,\n    p_limit     NUMBER DEFAULT 3\n) RETURN CLOB AS\n    v_result CLOB := '';\n    v_count NUMBER := 0;\nBEGIN\n    FOR rec IN (\n        SELECT \n            entity_id,\n            JSON_VALUE(content, '$.situation') as situation,\n            JSON_VALUE(content, '$.decision') as decision,\n            JSON_VALUE(content, '$.outcome') as outcome,\n            JSON_VALUE(content, '$.success') as success\n        FROM agent_memory\n        WHERE memory_type = 'DECISION'\n        AND (\n            UPPER(JSON_VALUE(content, '$.situation')) LIKE '%' || UPPER(p_situation) || '%'\n            OR UPPER(p_situation) LIKE '%' || UPPER(SUBSTR(JSON_VALUE(content, '$.situation'), 1, 20)) || '%'\n        )\n        ORDER BY created_at DESC\n        FETCH FIRST p_limit ROWS ONLY\n    ) LOOP\n        v_result := v_result || \n            'Situation: ' || rec.situation || CHR(10) ||\n            'Decision: ' || rec.decision || CHR(10) ||\n            'Outcome: ' || rec.outcome || \n            ' (Success: ' || rec.success || ')' || CHR(10) || '---' || CHR(10);\n        v_count := v_count + 1;\n    END LOOP;\n    \n    IF v_count = 0 THEN\n        RETURN 'No similar decisions found.';\n    END IF;\n    RETURN 'Found ' || v_count || ' similar decisions:' || CHR(10) || v_result;\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Record some decisions.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Record past decisions and their outcomes\nSELECT record_decision(\n    'CUST-001',\n    'Premium customer complained about shipping delay',\n    'Offered expedited shipping at no cost',\n    'Customer satisfied, relationship preserved',\n    'true'\n) FROM DUAL;\n\nSELECT record_decision(\n    'CUST-002',\n    'Standard customer requested refund after 45 days',\n    'Explained 30-day policy but offered store credit',\n    'Customer accepted store credit, positive resolution',\n    'true'\n) FROM DUAL;\n\nSELECT record_decision(\n    'CUST-003',\n    'Customer upset about billing error',\n    'Explained company policy without offering resolution',\n    'Customer cancelled account and posted negative review',\n    'false'\n) FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. Search for relevant past decisions.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Find decisions about shipping issues\nSELECT find_past_decisions('shipping') FROM DUAL;\n\n-- Find decisions about billing\nSELECT find_past_decisions('billing') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n## Task 5: Reference Knowledge (Policies and Procedures)\n\nReference knowledge is background information the agent consults but does not change.\n\n1. Create functions for reference knowledge.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Add reference knowledge (admin function)\nCREATE OR REPLACE FUNCTION add_reference(\n    p_category    VARCHAR2,\n    p_name        VARCHAR2,\n    p_content     VARCHAR2,\n    p_updated_by  VARCHAR2 DEFAULT USER\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\nBEGIN\n    INSERT INTO reference_knowledge (category, name, content, updated_by)\n    VALUES (\n        p_category,\n        p_name,\n        JSON_OBJECT('text' VALUE p_content),\n        p_updated_by\n    );\n    COMMIT;\n    RETURN 'Reference added: ' || p_name;\nEND;\n/\n\n-- Get reference knowledge (agent reads this)\nCREATE OR REPLACE FUNCTION get_reference(\n    p_category VARCHAR2 DEFAULT NULL,\n    p_name     VARCHAR2 DEFAULT NULL\n) RETURN CLOB AS\n    v_result CLOB := '';\n    v_count NUMBER := 0;\nBEGIN\n    FOR rec IN (\n        SELECT category, name, JSON_VALUE(content, '$.text') as text\n        FROM reference_knowledge\n        WHERE is_active = 1\n        AND (p_category IS NULL OR UPPER(category) LIKE '%' || UPPER(p_category) || '%')\n        AND (p_name IS NULL OR UPPER(name) LIKE '%' || UPPER(p_name) || '%')\n        ORDER BY category, name\n    ) LOOP\n        v_result := v_result || '[' || rec.category || '] ' || rec.name || ':' || CHR(10) ||\n                   rec.text || CHR(10) || CHR(10);\n        v_count := v_count + 1;\n    END LOOP;\n    \n    IF v_count = 0 THEN\n        RETURN 'No reference knowledge found.';\n    END IF;\n    RETURN 'Found ' || v_count || ' references:' || CHR(10) || v_result;\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Add reference knowledge (policies).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Add policies\nSELECT add_reference('policy', 'Return Policy - Premium', \n    'Premium members may return items within 90 days for full refund, no questions asked. ' ||\n    'Standard restocking fees are waived. Free return shipping included.') FROM DUAL;\n    \nSELECT add_reference('policy', 'Return Policy - Standard',\n    'Standard members may return items within 30 days. A 15% restocking fee applies. ' ||\n    'Customer pays return shipping.') FROM DUAL;\n    \nSELECT add_reference('procedure', 'Escalation Process',\n    'Billing disputes: 1) Agent attempts resolution, 2) If over $100, escalate to Team Lead, ' ||\n    '3) If unresolved after 24 hours, escalate to Manager, 4) Customer may request VP review.') FROM DUAL;\n    \nSELECT add_reference('guideline', 'Tone and Communication',\n    'Always be empathetic and solution-focused. Acknowledge customer frustration before ' ||\n    'explaining policy. Offer alternatives when saying no.') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. Query reference knowledge.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Get all policies\nSELECT get_reference('policy') FROM DUAL;\n\n-- Get escalation procedure\nSELECT get_reference('procedure', 'escalation') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n## Task 6: A Complete Example\n\nLet's trace how an agent would use all four types together.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Scenario: Customer CUST-001 calls about a late shipment\n\n-- 1. Set short-term context (current task)\nSELECT set_context('SESSION-002', 'customer', 'CUST-001 calling about late shipment') FROM DUAL;\nSELECT set_context('SESSION-002', 'issue', 'Order ORD-789 delayed 3 days') FROM DUAL;\n\n-- 2. Check long-term facts (what do we know about them?)\nSELECT get_facts('CUST-001') FROM DUAL;\n\n-- 3. Check reference knowledge (what's the policy?)\nSELECT get_reference('policy', 'return') FROM DUAL;\n\n-- 4. Find similar past decisions (what worked before?)\nSELECT find_past_decisions('shipping delay') FROM DUAL;\n\n-- 5. Agent makes decision based on all of this, then records it\nSELECT record_decision(\n    'CUST-001',\n    'Premium customer CUST-001 reported 3-day shipping delay on ORD-789',\n    'Offered expedited replacement shipping and $25 credit for inconvenience',\n    'Customer satisfied, appreciated proactive resolution',\n    'true'\n) FROM DUAL;\n\n-- 6. Learn new fact if relevant\nSELECT store_fact('CUST-001', 'Sensitive to shipping delays - prioritize expedited options', 'preference') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n## Summary\n\nIn this lab, you built the four types of agent memory:\n\n* **Short-term context** — Current task inputs (expires with task)\n* **Long-term facts** — Stable entity knowledge (persists forever)\n* **Decisions and outcomes** — Audit trail (persists forever)\n* **Reference knowledge** — Policies and procedures (human-maintained)\n\nTogether, these memories make agents consistent, contextual, and explainable.\n\n## Cleanup (Optional)",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nDROP TABLE agent_memory;\nDROP TABLE reference_knowledge;\nDROP FUNCTION set_context;\nDROP FUNCTION get_context;\nDROP FUNCTION store_fact;\nDROP FUNCTION get_facts;\nDROP FUNCTION record_decision;\nDROP FUNCTION find_past_decisions;\nDROP FUNCTION add_reference;\nDROP FUNCTION get_reference;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n## Learn More\n\n* [Oracle JSON Developer's Guide](https://docs.oracle.com/en/database/oracle/oracle-database/26/adjsn/)\n* [DBMS_CLOUD_AI_AGENT Package](https://docs.oracle.com/en/cloud/paas/autonomous-database/serverless/adbsb/dbms-cloud-ai-agent-package.html)\n\n## Acknowledgements\n\n* **Author** - David Start\n* **Last Updated By/Date** - David Start, January 2026",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    }
  ],
  "name": "Lab 8 - Four Memory Types",
  "id": "lab8-four-memory-types",
  "noteParams": {},
  "noteForms": {},
  "angularObjects": {},
  "config": { "isZeppelinNotebookCronEnable": false },
  "info": {}
}
