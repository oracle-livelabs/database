{
  "paragraphs": [
    {
      "text": "%md\n# Tools, Safety, and Human Control\n\n## Introduction\n\nIn this capstone lab, you'll build a complete agent system with tools that act, rules that constrain, and human oversight that keeps people in control.\n\nYou'll create two agents:\n- **EXPENSE_AGENT** — Employees use this to submit expenses\n- **APPROVAL_AGENT** — Managers use this to review and approve expenses\n\nThis separation demonstrates real-world agent design: different roles, different capabilities, different tools.\n\nEstimated Time: 25 minutes\n\n### Objectives\n\n* Create PL/SQL functions as agent tools\n* Build a safety rules system with JSON configuration\n* Create separate agents for different roles\n* See how agents respect rules and route work appropriately\n* Query the audit trail to see all actions\n\n### Prerequisites\n\nThis lab assumes you have:\n\n* Completed Labs 1-9 or have a working agent setup\n* An AI profile named `genai` already configured\n\n---\n\n## Part 1: The Data Model\n\n### Task 1: Create Tables\n\n1. Create the expense system tables.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Sequence for request IDs\nCREATE SEQUENCE expense_seq START WITH 1001;\n\n-- Employees table\nCREATE TABLE employees (\n    employee_id   VARCHAR2(20) PRIMARY KEY,\n    name          VARCHAR2(100) NOT NULL,\n    email         VARCHAR2(100) NOT NULL,\n    department    VARCHAR2(50),\n    manager_id    VARCHAR2(20)\n);\n\n-- Expense requests\nCREATE TABLE expense_requests (\n    request_id    VARCHAR2(20) PRIMARY KEY,\n    employee_id   VARCHAR2(20) NOT NULL REFERENCES employees(employee_id),\n    amount        NUMBER(10,2) NOT NULL \n                  CONSTRAINT chk_positive_amount CHECK (amount > 0),\n    category      VARCHAR2(50) NOT NULL\n                  CONSTRAINT chk_category CHECK (category IN ('travel','meals','supplies','equipment','training')),\n    description   VARCHAR2(500),\n    status        VARCHAR2(30) DEFAULT 'NEEDS_APPROVAL'\n                  CONSTRAINT chk_status CHECK (status IN ('APPROVED','REJECTED','NEEDS_APPROVAL')),\n    submitted_at  TIMESTAMP DEFAULT SYSTIMESTAMP,\n    approved_by   VARCHAR2(100),\n    approved_at   TIMESTAMP\n);\n\n-- Safety rules\nCREATE TABLE safety_rules (\n    rule_id      RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,\n    rule_name    VARCHAR2(200) NOT NULL,\n    rule_type    VARCHAR2(20) NOT NULL \n                 CONSTRAINT chk_rule_type CHECK (rule_type IN ('BLOCK','REQUIRE_APPROVAL','AUTO_APPROVE')),\n    rule_config  JSON NOT NULL,\n    priority     NUMBER DEFAULT 100,\n    is_active    NUMBER(1) DEFAULT 1\n);\n\n-- Insert sample employees\nINSERT INTO employees VALUES ('EMP-001', 'Alice Johnson', 'alice@company.com', 'Engineering', NULL);\nINSERT INTO employees VALUES ('EMP-002', 'Bob Smith', 'bob@company.com', 'Sales', 'EMP-001');\nINSERT INTO employees VALUES ('EMP-003', 'Carol Davis', 'carol@company.com', 'Marketing', 'EMP-001');\n\nCOMMIT;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n### Task 2: Create Safety Rules\n\n1. Add the business rules.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Block excessive amounts (>$5000)\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'Block Excessive Expense',\n    'BLOCK',\n    '{\"field\": \"amount\", \"operator\": \"gt\", \"value\": 5000, \"message\": \"Expenses over $5,000 are not permitted. Contact Finance directly.\"}',\n    10\n);\n\n-- Require approval for high amounts (>=$1000)\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'High Amount Approval',\n    'REQUIRE_APPROVAL',\n    '{\"field\": \"amount\", \"operator\": \"gte\", \"value\": 1000, \"message\": \"Expenses $1,000 and above require manager approval.\"}',\n    20\n);\n\n-- Require approval for equipment (any amount)\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'Equipment Approval',\n    'REQUIRE_APPROVAL',\n    '{\"field\": \"category\", \"operator\": \"eq\", \"value\": \"equipment\", \"message\": \"Equipment purchases require manager approval.\"}',\n    30\n);\n\n-- Auto-approve everything else under $1000\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'Auto-approve Standard',\n    'AUTO_APPROVE',\n    '{\"field\": \"amount\", \"operator\": \"lt\", \"value\": 1000, \"message\": \"Expenses under $1,000 are auto-approved.\"}',\n    100\n);\n\nCOMMIT;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n---\n\n## Part 2: Tool Functions\n\n### Task 3: Create the Rules Checker\n\n1. Create the function that checks safety rules.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION check_expense_rules(\n    p_amount   NUMBER,\n    p_category VARCHAR2\n) RETURN VARCHAR2 AS\nBEGIN\n    FOR rec IN (\n        SELECT rule_name, rule_type, rule_config\n        FROM safety_rules\n        WHERE is_active = 1\n        ORDER BY priority\n    ) LOOP\n        DECLARE\n            v_field    VARCHAR2(50) := JSON_VALUE(rec.rule_config, '$.field');\n            v_operator VARCHAR2(10) := JSON_VALUE(rec.rule_config, '$.operator');\n            v_value    VARCHAR2(100) := JSON_VALUE(rec.rule_config, '$.value');\n            v_message  VARCHAR2(500) := JSON_VALUE(rec.rule_config, '$.message');\n            v_match    BOOLEAN := FALSE;\n        BEGIN\n            IF v_field = 'amount' THEN\n                IF v_operator = 'gt' AND p_amount > TO_NUMBER(v_value) THEN v_match := TRUE;\n                ELSIF v_operator = 'gte' AND p_amount >= TO_NUMBER(v_value) THEN v_match := TRUE;\n                ELSIF v_operator = 'lt' AND p_amount < TO_NUMBER(v_value) THEN v_match := TRUE;\n                END IF;\n            ELSIF v_field = 'category' THEN\n                IF v_operator = 'eq' AND LOWER(p_category) = LOWER(v_value) THEN v_match := TRUE;\n                END IF;\n            END IF;\n            \n            IF v_match THEN\n                RETURN '{\"action\": \"' || rec.rule_type || '\", \"rule\": \"' || rec.rule_name || '\", \"message\": \"' || v_message || '\"}';\n            END IF;\n        END;\n    END LOOP;\n    \n    RETURN '{\"action\": \"AUTO_APPROVE\", \"message\": \"Standard processing.\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Test the rules.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT '$35 supplies:' as test, check_expense_rules(35, 'supplies') as result FROM DUAL\nUNION ALL\nSELECT '$200 meals:', check_expense_rules(200, 'meals') FROM DUAL\nUNION ALL\nSELECT '$1500 training:', check_expense_rules(1500, 'training') FROM DUAL\nUNION ALL\nSELECT '$150 equipment:', check_expense_rules(150, 'equipment') FROM DUAL\nUNION ALL\nSELECT '$7500 travel:', check_expense_rules(7500, 'travel') FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n### Task 4: Create Expense Submission Tool\n\n1. Create the submit function that respects the rules.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION submit_expense(\n    p_employee_id VARCHAR2,\n    p_amount      NUMBER,\n    p_category    VARCHAR2,\n    p_description VARCHAR2\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\n    v_request_id VARCHAR2(20);\n    v_rules      VARCHAR2(500);\n    v_action     VARCHAR2(20);\n    v_status     VARCHAR2(30);\nBEGIN\n    -- Check rules first\n    v_rules := check_expense_rules(p_amount, p_category);\n    v_action := JSON_VALUE(v_rules, '$.action');\n    \n    -- Handle BLOCK - don't create the expense\n    IF v_action = 'BLOCK' THEN\n        RETURN '{\"error\": \"BLOCKED\", \"message\": \"' || JSON_VALUE(v_rules, '$.message') || '\"}';\n    END IF;\n    \n    -- Determine status\n    IF v_action = 'AUTO_APPROVE' THEN\n        v_status := 'APPROVED';\n    ELSE\n        v_status := 'NEEDS_APPROVAL';\n    END IF;\n    \n    -- Generate request ID and insert\n    v_request_id := 'EXP-' || TO_CHAR(SYSDATE, 'YYMMDD') || '-' || expense_seq.NEXTVAL;\n    \n    INSERT INTO expense_requests (request_id, employee_id, amount, category, description, status, approved_by, approved_at)\n    VALUES (\n        v_request_id, \n        p_employee_id, \n        p_amount, \n        LOWER(p_category), \n        p_description,\n        v_status,\n        CASE WHEN v_status = 'APPROVED' THEN 'AUTO' ELSE NULL END,\n        CASE WHEN v_status = 'APPROVED' THEN SYSTIMESTAMP ELSE NULL END\n    );\n    \n    COMMIT;\n    \n    RETURN '{\"request_id\": \"' || v_request_id || '\", \"status\": \"' || v_status || '\", \"message\": \"' || \n           CASE WHEN v_status = 'APPROVED' THEN 'Auto-approved.' ELSE 'Submitted. Awaiting manager approval.' END || '\"}';\nEXCEPTION\n    WHEN OTHERS THEN\n        ROLLBACK;\n        RETURN '{\"error\": \"' || SQLERRM || '\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n### Task 5: Create Approval Tools\n\n1. Create a function to list expenses needing approval.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION get_pending_approvals RETURN VARCHAR2 AS\n    v_result VARCHAR2(4000) := '[';\n    v_first  BOOLEAN := TRUE;\nBEGIN\n    FOR rec IN (\n        SELECT e.request_id, emp.name as employee_name, e.amount, e.category, \n               e.description, TO_CHAR(e.submitted_at, 'YYYY-MM-DD HH24:MI') as submitted\n        FROM expense_requests e\n        JOIN employees emp ON e.employee_id = emp.employee_id\n        WHERE e.status = 'NEEDS_APPROVAL'\n        ORDER BY e.submitted_at\n    ) LOOP\n        IF NOT v_first THEN\n            v_result := v_result || ',';\n        END IF;\n        v_first := FALSE;\n        \n        v_result := v_result || '{\"request_id\": \"' || rec.request_id || '\", ' ||\n                    '\"employee\": \"' || rec.employee_name || '\", ' ||\n                    '\"amount\": ' || rec.amount || ', ' ||\n                    '\"category\": \"' || rec.category || '\", ' ||\n                    '\"description\": \"' || NVL(rec.description, 'N/A') || '\", ' ||\n                    '\"submitted\": \"' || rec.submitted || '\"}';\n    END LOOP;\n    \n    v_result := v_result || ']';\n    \n    IF v_result = '[]' THEN\n        RETURN '{\"message\": \"No expenses pending approval.\"}';\n    END IF;\n    \n    RETURN v_result;\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Create a function to approve an expense.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION approve_expense(\n    p_request_id VARCHAR2,\n    p_approver   VARCHAR2 DEFAULT 'MANAGER'\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\n    v_current_status VARCHAR2(30);\nBEGIN\n    -- Check current status\n    SELECT status INTO v_current_status\n    FROM expense_requests\n    WHERE request_id = p_request_id;\n    \n    IF v_current_status != 'NEEDS_APPROVAL' THEN\n        RETURN '{\"error\": \"Cannot approve. Current status is ' || v_current_status || '.\"}';\n    END IF;\n    \n    -- Approve it\n    UPDATE expense_requests\n    SET status = 'APPROVED',\n        approved_by = p_approver,\n        approved_at = SYSTIMESTAMP\n    WHERE request_id = p_request_id;\n    \n    COMMIT;\n    RETURN '{\"request_id\": \"' || p_request_id || '\", \"status\": \"APPROVED\", \"approved_by\": \"' || p_approver || '\"}';\nEXCEPTION\n    WHEN NO_DATA_FOUND THEN\n        RETURN '{\"error\": \"Expense not found: ' || p_request_id || '\"}';\n    WHEN OTHERS THEN\n        ROLLBACK;\n        RETURN '{\"error\": \"' || SQLERRM || '\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. Create a function to reject an expense.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION reject_expense(\n    p_request_id VARCHAR2,\n    p_approver   VARCHAR2 DEFAULT 'MANAGER'\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\n    v_current_status VARCHAR2(30);\nBEGIN\n    SELECT status INTO v_current_status\n    FROM expense_requests\n    WHERE request_id = p_request_id;\n    \n    IF v_current_status != 'NEEDS_APPROVAL' THEN\n        RETURN '{\"error\": \"Cannot reject. Current status is ' || v_current_status || '.\"}';\n    END IF;\n    \n    UPDATE expense_requests\n    SET status = 'REJECTED',\n        approved_by = p_approver,\n        approved_at = SYSTIMESTAMP\n    WHERE request_id = p_request_id;\n    \n    COMMIT;\n    RETURN '{\"request_id\": \"' || p_request_id || '\", \"status\": \"REJECTED\", \"rejected_by\": \"' || p_approver || '\"}';\nEXCEPTION\n    WHEN NO_DATA_FOUND THEN\n        RETURN '{\"error\": \"Expense not found: ' || p_request_id || '\"}';\n    WHEN OTHERS THEN\n        ROLLBACK;\n        RETURN '{\"error\": \"' || SQLERRM || '\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n---\n\n## Part 3: Create the Agents\n\n### Task 6: Register Tools\n\n1. Register all tools.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nBEGIN\n    -- Submission tool (for EXPENSE_AGENT)\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'SUBMIT_EXPENSE_TOOL',\n        attributes  => '{\"instruction\": \"Submit an expense request. Parameters: P_EMPLOYEE_ID (e.g. EMP-001, EMP-002, EMP-003), P_AMOUNT (number), P_CATEGORY (travel, meals, supplies, equipment, or training), P_DESCRIPTION (text description of the expense).\",\n                        \"function\": \"submit_expense\"}',\n        description => 'Submits an expense request'\n    );\n    \n    -- Pending list tool (for APPROVAL_AGENT)\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'GET_PENDING_TOOL',\n        attributes  => '{\"instruction\": \"Get list of expenses waiting for approval. No parameters needed.\",\n                        \"function\": \"get_pending_approvals\"}',\n        description => 'Lists expenses needing approval'\n    );\n    \n    -- Approve tool (for APPROVAL_AGENT)\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'APPROVE_EXPENSE_TOOL',\n        attributes  => '{\"instruction\": \"Approve an expense request. Parameter: P_REQUEST_ID (e.g. EXP-260108-1001).\",\n                        \"function\": \"approve_expense\"}',\n        description => 'Approves an expense'\n    );\n    \n    -- Reject tool (for APPROVAL_AGENT)\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'REJECT_EXPENSE_TOOL',\n        attributes  => '{\"instruction\": \"Reject an expense request. Parameter: P_REQUEST_ID (e.g. EXP-260108-1001).\",\n                        \"function\": \"reject_expense\"}',\n        description => 'Rejects an expense'\n    );\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n### Task 7: Create the Expense Agent (Employee Role)\n\n1. Create the expense submission agent and team.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_AGENT(\n        agent_name  => 'EXPENSE_AGENT',\n        attributes  => '{\"profile_name\": \"genai\",\n                        \"role\": \"You are an expense submission agent for employees. When asked to submit an expense, call SUBMIT_EXPENSE_TOOL with the provided details. Report the result clearly - whether it was auto-approved, needs manager approval, or was blocked.\"}',\n        description => 'Employee expense submission agent'\n    );\nEND;\n/\n\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_TASK(\n        task_name   => 'EXPENSE_TASK',\n        attributes  => '{\"instruction\": \"Process expense submission requests. Call SUBMIT_EXPENSE_TOOL with the employee ID, amount, category, and description. Report the outcome. User request: {query}\",\n                        \"tools\": [\"SUBMIT_EXPENSE_TOOL\"]}',\n        description => 'Expense submission task'\n    );\nEND;\n/\n\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_TEAM(\n        team_name   => 'EXPENSE_TEAM',\n        attributes  => '{\"agents\": [{\"name\": \"EXPENSE_AGENT\", \"task\": \"EXPENSE_TASK\"}],\n                        \"process\": \"sequential\"}',\n        description => 'Employee expense submission team'\n    );\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n### Task 8: Create the Approval Agent (Manager Role)\n\n1. Create the manager approval agent and team.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_AGENT(\n        agent_name  => 'APPROVAL_AGENT',\n        attributes  => '{\"profile_name\": \"genai\",\n                        \"role\": \"You are an expense approval agent for managers. You can list pending expenses, approve them, or reject them. When asked what needs approval, call GET_PENDING_TOOL. When asked to approve, call APPROVE_EXPENSE_TOOL. When asked to reject, call REJECT_EXPENSE_TOOL.\"}',\n        description => 'Manager expense approval agent'\n    );\nEND;\n/\n\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_TASK(\n        task_name   => 'APPROVAL_TASK',\n        attributes  => '{\"instruction\": \"Process expense approval requests. To see pending expenses, call GET_PENDING_TOOL. To approve, call APPROVE_EXPENSE_TOOL with the request ID. To reject, call REJECT_EXPENSE_TOOL with the request ID. User request: {query}\",\n                        \"tools\": [\"GET_PENDING_TOOL\", \"APPROVE_EXPENSE_TOOL\", \"REJECT_EXPENSE_TOOL\"]}',\n        description => 'Expense approval task'\n    );\nEND;\n/\n\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_TEAM(\n        team_name   => 'APPROVAL_TEAM',\n        attributes  => '{\"agents\": [{\"name\": \"APPROVAL_AGENT\", \"task\": \"APPROVAL_TASK\"}],\n                        \"process\": \"sequential\"}',\n        description => 'Manager expense approval team'\n    );\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n---\n\n## Part 4: Test the Workflow\n\n### Task 9: Submit Expenses as an Employee\n\n1. Set the expense submission team.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nEXEC DBMS_CLOUD_AI_AGENT.SET_TEAM('EXPENSE_TEAM');",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Submit a small expense (auto-approve).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $35 expense for supplies for employee EMP-002, description office supplies;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected:** Auto-approved (under $1000, not equipment).\n\n3. Submit a medium expense (auto-approve).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $200 expense for meals for employee EMP-003, description team lunch;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected:** Auto-approved (under $1000, not equipment).\n\n4. Submit a high-value expense (needs approval).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $1500 expense for training for employee EMP-002, description annual conference registration;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected:** Needs approval ($1000 or more).\n\n5. Submit an equipment expense (needs approval).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $150 expense for equipment for employee EMP-002, description new keyboard;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected:** Needs approval (equipment category always requires approval).\n\n6. Try to submit a blocked expense.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $7500 expense for travel for employee EMP-001, description international trip;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected:** Blocked (over $5000).\n\n7. Verify the expense records.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT request_id, \n       (SELECT name FROM employees WHERE employee_id = e.employee_id) as employee,\n       amount, \n       category, \n       status, \n       NVL(approved_by, '-') as approved_by\nFROM expense_requests e\nORDER BY submitted_at;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected Results:**\n\n| Amount | Category | Status | Approved By |\n|--------|----------|--------|-------------|\n| $35 | supplies | APPROVED | AUTO |\n| $200 | meals | APPROVED | AUTO |\n| $1500 | training | NEEDS_APPROVAL | - |\n| $150 | equipment | NEEDS_APPROVAL | - |\n\nNote: The $7500 expense was blocked and not created.\n\n---\n\n### Task 10: Approve Expenses as a Manager\n\n1. Switch to the approval team.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nEXEC DBMS_CLOUD_AI_AGENT.SET_TEAM('APPROVAL_TEAM');",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Ask what expenses need approval.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT What expenses need my approval;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected:** Lists the $1500 training and $150 equipment expenses.\n\n3. Approve the training expense.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Approve the training expense;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n4. Reject the equipment expense.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Reject the equipment expense;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n5. Verify final status of all expenses.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT request_id, \n       (SELECT name FROM employees WHERE employee_id = e.employee_id) as employee,\n       amount, \n       category, \n       status, \n       NVL(approved_by, '-') as approved_by,\n       TO_CHAR(approved_at, 'HH24:MI:SS') as approved_at\nFROM expense_requests e\nORDER BY submitted_at;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Expected Final Results:**\n\n| Amount | Category | Status | Approved By |\n|--------|----------|--------|-------------|\n| $35 | supplies | APPROVED | AUTO |\n| $200 | meals | APPROVED | AUTO |\n| $1500 | training | APPROVED | MANAGER |\n| $150 | equipment | REJECTED | MANAGER |\n\n---\n\n## Part 5: Audit Trail\n\n### Task 11: Query the Audit Trail\n\n1. See all tool calls.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT \n    tool_name,\n    TO_CHAR(start_date, 'HH24:MI:SS') as called,\n    SUBSTR(input, 1, 60) as input_preview,\n    SUBSTR(output, 1, 60) as output_preview\nFROM USER_AI_AGENT_TOOL_HISTORY\nORDER BY start_date DESC\nFETCH FIRST 15 ROWS ONLY;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Audit summary by tool.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT \n    tool_name,\n    COUNT(*) as call_count\nFROM USER_AI_AGENT_TOOL_HISTORY\nGROUP BY tool_name\nORDER BY call_count DESC;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n---\n\n## Summary\n\nIn this capstone lab, you built a complete agent system with:\n\n**Two Agents with Different Roles:**\n- EXPENSE_AGENT — Employees submit expenses\n- APPROVAL_AGENT — Managers review and decide\n\n**Safety Rules:**\n- AUTO_APPROVE: Under $1000 (not equipment)\n- REQUIRE_APPROVAL: $1000+ or equipment\n- BLOCK: Over $5000\n\n**Clean Workflow:**\n1. Employee submits → Auto-approved or queued for approval\n2. Manager reviews queue → Approves or rejects\n3. Everything logged in audit trail\n\n**Key Takeaways:**\n- Tools define what's possible\n- Rules define what's allowed\n- Different agents for different roles\n- Humans retain control over important decisions\n- Everything is auditable\n\n## Learn More\n\n* [DBMS_CLOUD_AI_AGENT Package](https://docs.oracle.com/en/cloud/paas/autonomous-database/serverless/adbsb/dbms-cloud-ai-agent-package.html)\n\n## Acknowledgements\n\n* **Author** - David Start\n* **Last Updated By/Date** - David Start, January 2026",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%md\n## Cleanup (Optional)",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TEAM('EXPENSE_TEAM', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TEAM('APPROVAL_TEAM', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TASK('EXPENSE_TASK', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TASK('APPROVAL_TASK', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_AGENT('EXPENSE_AGENT', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_AGENT('APPROVAL_AGENT', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('SUBMIT_EXPENSE_TOOL', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('GET_PENDING_TOOL', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('APPROVE_EXPENSE_TOOL', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('REJECT_EXPENSE_TOOL', TRUE);\nDROP TABLE expense_requests PURGE;\nDROP TABLE employees PURGE;\nDROP TABLE safety_rules PURGE;\nDROP SEQUENCE expense_seq;\nDROP FUNCTION submit_expense;\nDROP FUNCTION check_expense_rules;\nDROP FUNCTION get_pending_approvals;\nDROP FUNCTION approve_expense;\nDROP FUNCTION reject_expense;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    }
  ],
  "name": "Lab 10 - Tools Safety Control",
  "id": "lab10-tools-safety-control",
  "noteParams": {},
  "noteForms": {},
  "angularObjects": {},
  "config": { "isZeppelinNotebookCronEnable": false },
  "info": {}
}