{
  "paragraphs": [
    {
      "text": "%md\n# Tools, Safety, and Human Control\n\n## Introduction\n\nIn this capstone lab, you'll build a complete agent system with tools that act, rules that constrain, and human oversight that keeps people in control.\n\nAgents don't act directly on systems—they act through tools you explicitly build and register. This separation is what makes agents both powerful and safe. Tools define what's *possible*. Rules define what's *allowed*. Human-in-the-loop defines when to *pause*.\n\nYou'll create an expense processing agent with multiple tools, add safety rules that enforce business policies, enable human approval for high-stakes decisions, and query the audit trail to see everything that happened.\n\nEstimated Time: 25 minutes\n\n### Objectives\n\n* Create PL/SQL functions as agent tools\n* Build a safety rules system with JSON configuration\n* Add database constraints as a backstop\n* Enable human-in-the-loop for approval workflows\n* Query the audit trail to see all actions\n\n### Prerequisites\n\nThis lab assumes you have:\n\n* Completed Labs 1-9 or have a working agent setup\n* An AI profile named `genai` already configured\n\n---\n\n## Part 1: Tools That Act\n\nTools are PL/SQL functions that agents can call. They're the only way an agent can affect your systems.\n\n### Task 1: Create the Data Model\n\n1. Create tables with built-in constraints (safety at the database level).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Sequence for request IDs\nCREATE SEQUENCE expense_seq START WITH 1001;\n\n-- Employees table\nCREATE TABLE employees (\n    employee_id   VARCHAR2(20) PRIMARY KEY,\n    name          VARCHAR2(100) NOT NULL,\n    email         VARCHAR2(100) NOT NULL,\n    department    VARCHAR2(50),\n    manager_id    VARCHAR2(20),\n    expense_limit NUMBER(10,2) DEFAULT 500\n);\n\n-- Expense requests with constraints\nCREATE TABLE expense_requests (\n    request_id    VARCHAR2(20) PRIMARY KEY,\n    employee_id   VARCHAR2(20) NOT NULL REFERENCES employees(employee_id),\n    amount        NUMBER(10,2) NOT NULL \n                  CONSTRAINT chk_positive_amount CHECK (amount > 0),\n    category      VARCHAR2(50) NOT NULL\n                  CONSTRAINT chk_category CHECK (category IN ('travel','meals','supplies','equipment','training')),\n    description   VARCHAR2(500),\n    status        VARCHAR2(30) DEFAULT 'PENDING'\n                  CONSTRAINT chk_status CHECK (status IN ('PENDING','APPROVED','REJECTED','NEEDS_APPROVAL','PAID')),\n    submitted_at  TIMESTAMP DEFAULT SYSTIMESTAMP,\n    approved_by   VARCHAR2(100),\n    approved_at   TIMESTAMP\n);\n\n-- Insert sample employees\nINSERT INTO employees VALUES ('EMP-001', 'Alice Johnson', 'alice@company.com', 'Engineering', NULL, 1000);\nINSERT INTO employees VALUES ('EMP-002', 'Bob Smith', 'bob@company.com', 'Sales', 'EMP-001', 500);\nINSERT INTO employees VALUES ('EMP-003', 'Carol Davis', 'carol@company.com', 'Marketing', 'EMP-001', 500);\n\nCOMMIT;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n### Task 2: Create Tool Functions\n\n1. Create the expense submission tool.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION submit_expense(\n    p_employee_id VARCHAR2,\n    p_amount      NUMBER,\n    p_category    VARCHAR2,\n    p_description VARCHAR2\n) RETURN VARCHAR2 AS\n    PRAGMA AUTONOMOUS_TRANSACTION;\n    v_request_id VARCHAR2(20);\n    v_status VARCHAR2(30);\nBEGIN\n    -- Generate request ID\n    v_request_id := 'EXP-' || TO_CHAR(SYSDATE, 'YYMMDD') || '-' || expense_seq.NEXTVAL;\n    \n    -- Determine status based on amount\n    -- Small expenses (<$50) are auto-approved\n    -- Medium expenses are pending\n    -- Large expenses ($1000+) or equipment need approval\n    IF p_amount < 50 THEN\n        v_status := 'APPROVED';  -- Auto-approved\n    ELSIF p_amount >= 1000 OR LOWER(p_category) = 'equipment' THEN\n        v_status := 'NEEDS_APPROVAL';\n    ELSE\n        v_status := 'PENDING';\n    END IF;\n    \n    -- Insert the request\n    INSERT INTO expense_requests (request_id, employee_id, amount, category, description, status, approved_by, approved_at)\n    VALUES (\n        v_request_id, \n        p_employee_id, \n        p_amount, \n        LOWER(p_category), \n        p_description,\n        v_status,\n        CASE WHEN v_status = 'APPROVED' THEN 'AUTO' ELSE NULL END,\n        CASE WHEN v_status = 'APPROVED' THEN SYSTIMESTAMP ELSE NULL END\n    );\n    \n    COMMIT;\n    \n    RETURN '{\"request_id\": \"' || v_request_id || '\", ' ||\n           '\"status\": \"' || v_status || '\", ' ||\n           '\"message\": \"' || CASE \n               WHEN v_status = 'APPROVED' THEN 'Expense auto-approved (under $50).'\n               WHEN v_status = 'NEEDS_APPROVAL' THEN 'Expense requires manager approval.'\n               ELSE 'Expense submitted successfully.'\n           END || '\"}';\nEXCEPTION\n    WHEN OTHERS THEN\n        ROLLBACK;\n        RETURN '{\"error\": \"' || SQLERRM || '\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Create an expense lookup tool.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION get_expense_status(\n    p_request_id VARCHAR2\n) RETURN VARCHAR2 AS\n    v_result VARCHAR2(500);\nBEGIN\n    SELECT '{\"request_id\": \"' || request_id || '\", ' ||\n           '\"employee\": \"' || (SELECT name FROM employees WHERE employee_id = e.employee_id) || '\", ' ||\n           '\"amount\": ' || amount || ', ' ||\n           '\"category\": \"' || category || '\", ' ||\n           '\"status\": \"' || status || '\", ' ||\n           '\"submitted\": \"' || TO_CHAR(submitted_at, 'YYYY-MM-DD HH24:MI') || '\", ' ||\n           '\"approved_by\": \"' || NVL(approved_by, 'N/A') || '\"}'\n    INTO v_result\n    FROM expense_requests e\n    WHERE request_id = p_request_id;\n    \n    RETURN v_result;\nEXCEPTION\n    WHEN NO_DATA_FOUND THEN\n        RETURN '{\"error\": \"Expense not found: ' || p_request_id || '\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. Create an employee lookup tool.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION get_employee_info(\n    p_employee_id VARCHAR2\n) RETURN VARCHAR2 AS\n    v_result VARCHAR2(500);\nBEGIN\n    SELECT '{\"employee_id\": \"' || employee_id || '\", ' ||\n           '\"name\": \"' || name || '\", ' ||\n           '\"department\": \"' || department || '\", ' ||\n           '\"expense_limit\": ' || expense_limit || '}'\n    INTO v_result\n    FROM employees\n    WHERE employee_id = p_employee_id;\n    \n    RETURN v_result;\nEXCEPTION\n    WHEN NO_DATA_FOUND THEN\n        RETURN '{\"error\": \"Employee not found: ' || p_employee_id || '\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n---\n\n## Part 2: Safety Rules\n\nTools define what's possible. Rules define what's allowed. We'll create a flexible rules system using JSON.\n\n### Task 3: Create the Rules System\n\n1. Create a safety rules table.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE TABLE safety_rules (\n    rule_id      RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,\n    rule_name    VARCHAR2(200) NOT NULL,\n    rule_type    VARCHAR2(20) NOT NULL \n                 CONSTRAINT chk_rule_type CHECK (rule_type IN ('BLOCK','REQUIRE_APPROVAL','WARN','AUTO_APPROVE')),\n    rule_config  JSON NOT NULL,\n    priority     NUMBER DEFAULT 100,\n    is_active    NUMBER(1) DEFAULT 1,\n    created_at   TIMESTAMP DEFAULT SYSTIMESTAMP\n);",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Add safety rules.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Block excessive amounts\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'Block Excessive Expense',\n    'BLOCK',\n    '{\"field\": \"amount\", \"operator\": \"gt\", \"value\": 5000, \"message\": \"Expenses over $5,000 are not permitted through self-service. Contact Finance directly.\"}',\n    10\n);\n\n-- Require approval for high amounts\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'High Amount Approval',\n    'REQUIRE_APPROVAL',\n    '{\"field\": \"amount\", \"operator\": \"gte\", \"value\": 1000, \"message\": \"Expenses $1,000 and above require manager approval.\"}',\n    20\n);\n\n-- Require approval for equipment\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'Equipment Approval',\n    'REQUIRE_APPROVAL',\n    '{\"field\": \"category\", \"operator\": \"eq\", \"value\": \"equipment\", \"message\": \"Equipment purchases require manager approval regardless of amount.\"}',\n    30\n);\n\n-- Auto-approve small expenses\nINSERT INTO safety_rules (rule_name, rule_type, rule_config, priority) VALUES (\n    'Auto-approve Small',\n    'AUTO_APPROVE',\n    '{\"field\": \"amount\", \"operator\": \"lt\", \"value\": 50, \"message\": \"Small expenses under $50 are auto-approved.\"}',\n    100\n);\n\nCOMMIT;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. Create the rules checking function.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nCREATE OR REPLACE FUNCTION check_expense_rules(\n    p_amount   NUMBER,\n    p_category VARCHAR2\n) RETURN VARCHAR2 AS\n    v_result JSON;\nBEGIN\n    -- Check rules in priority order\n    FOR rec IN (\n        SELECT rule_name, rule_type, rule_config\n        FROM safety_rules\n        WHERE is_active = 1\n        ORDER BY priority\n    ) LOOP\n        DECLARE\n            v_field    VARCHAR2(50) := JSON_VALUE(rec.rule_config, '$.field');\n            v_operator VARCHAR2(10) := JSON_VALUE(rec.rule_config, '$.operator');\n            v_value    VARCHAR2(100) := JSON_VALUE(rec.rule_config, '$.value');\n            v_message  VARCHAR2(500) := JSON_VALUE(rec.rule_config, '$.message');\n            v_match    BOOLEAN := FALSE;\n        BEGIN\n            -- Evaluate rule\n            IF v_field = 'amount' THEN\n                IF v_operator = 'gt' AND p_amount > TO_NUMBER(v_value) THEN v_match := TRUE;\n                ELSIF v_operator = 'gte' AND p_amount >= TO_NUMBER(v_value) THEN v_match := TRUE;\n                ELSIF v_operator = 'lt' AND p_amount < TO_NUMBER(v_value) THEN v_match := TRUE;\n                ELSIF v_operator = 'lte' AND p_amount <= TO_NUMBER(v_value) THEN v_match := TRUE;\n                ELSIF v_operator = 'eq' AND p_amount = TO_NUMBER(v_value) THEN v_match := TRUE;\n                END IF;\n            ELSIF v_field = 'category' THEN\n                IF v_operator = 'eq' AND LOWER(p_category) = LOWER(v_value) THEN v_match := TRUE;\n                END IF;\n            END IF;\n            \n            -- Return first matching rule\n            IF v_match THEN\n                IF rec.rule_type = 'BLOCK' THEN\n                    RETURN '{\"allowed\": false, \"action\": \"BLOCKED\", \"rule\": \"' || rec.rule_name || '\", \"message\": \"' || v_message || '\"}';\n                ELSIF rec.rule_type = 'REQUIRE_APPROVAL' THEN\n                    RETURN '{\"allowed\": true, \"action\": \"NEEDS_APPROVAL\", \"rule\": \"' || rec.rule_name || '\", \"message\": \"' || v_message || '\"}';\n                ELSIF rec.rule_type = 'AUTO_APPROVE' THEN\n                    RETURN '{\"allowed\": true, \"action\": \"AUTO_APPROVED\", \"rule\": \"' || rec.rule_name || '\", \"message\": \"' || v_message || '\"}';\n                END IF;\n            END IF;\n        END;\n    END LOOP;\n    \n    -- No rule matched - allow with standard processing\n    RETURN '{\"allowed\": true, \"action\": \"STANDARD\", \"message\": \"No special rules apply. Standard processing.\"}';\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n4. Test the rules.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\n-- Test various scenarios\nSELECT check_expense_rules(25, 'meals') as small_expense FROM DUAL;\nSELECT check_expense_rules(500, 'travel') as medium_expense FROM DUAL;\nSELECT check_expense_rules(1500, 'training') as large_expense FROM DUAL;\nSELECT check_expense_rules(200, 'equipment') as equipment_expense FROM DUAL;\nSELECT check_expense_rules(10000, 'travel') as blocked_expense FROM DUAL;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n---\n\n## Part 3: Human-in-the-Loop\n\nSome decisions need human judgment. Oracle's agent framework supports genuine pauses for approval.\n\n### Task 4: Register Tools and Create the Agent\n\n1. Register all tools.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nBEGIN\n    -- Submit expense tool\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'SUBMIT_EXPENSE_TOOL',\n        attributes  => '{\"instruction\": \"Submit an expense request. Parameters: P_EMPLOYEE_ID (e.g. EMP-001), P_AMOUNT (number), P_CATEGORY (travel, meals, supplies, equipment, or training), P_DESCRIPTION (text). Returns request ID and status.\",\n                        \"function\": \"submit_expense\"}',\n        description => 'Creates an expense request and returns the request ID'\n    );\n    \n    -- Check rules tool\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'CHECK_RULES_TOOL',\n        attributes  => '{\"instruction\": \"ALWAYS call this BEFORE submitting an expense to check if it is allowed. Parameters: P_AMOUNT (number), P_CATEGORY (travel, meals, supplies, equipment, or training). Returns whether expense is allowed, blocked, or needs approval.\",\n                        \"function\": \"check_expense_rules\"}',\n        description => 'Validates expense against safety rules - call this first'\n    );\n    \n    -- Get expense status tool\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'GET_EXPENSE_TOOL',\n        attributes  => '{\"instruction\": \"Look up expense status by request ID. Parameter: P_REQUEST_ID (e.g. EXP-250107-1001). Returns expense details.\",\n                        \"function\": \"get_expense_status\"}',\n        description => 'Retrieves expense request details by ID'\n    );\n    \n    -- Get employee info tool\n    DBMS_CLOUD_AI_AGENT.CREATE_TOOL(\n        tool_name   => 'GET_EMPLOYEE_TOOL',\n        attributes  => '{\"instruction\": \"Look up employee information. Parameter: P_EMPLOYEE_ID (e.g. EMP-001). Returns employee name, department, and expense limit.\",\n                        \"function\": \"get_employee_info\"}',\n        description => 'Retrieves employee details including expense limit'\n    );\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Create the agent with human-in-the-loop enabled.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_AGENT(\n        agent_name  => 'EXPENSE_AGENT',\n        attributes  => '{\"profile_name\": \"genai\",\n                        \"role\": \"You are an expense processing agent. ALWAYS check rules with CHECK_RULES_TOOL before submitting any expense. If the rules say BLOCKED, explain why and do NOT submit. If the rules say NEEDS_APPROVAL, do NOT submit - explain that approval is required and stop. Only submit if the rules say AUTO_APPROVED or STANDARD.\"}',\n        description => 'Expense processing agent with safety controls'\n    );\nEND;\n/\n\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_TASK(\n        task_name   => 'EXPENSE_TASK',\n        attributes  => '{\"instruction\": \"Process expense requests following this workflow: 1. First, call CHECK_RULES_TOOL to validate the expense 2. If BLOCKED: Explain why and do NOT call SUBMIT_EXPENSE_TOOL 3. If NEEDS_APPROVAL: Explain that manager approval is required and do NOT call SUBMIT_EXPENSE_TOOL 4. If AUTO_APPROVED or STANDARD: Call SUBMIT_EXPENSE_TOOL. User request: {query}\",\n                        \"tools\": [\"CHECK_RULES_TOOL\", \"SUBMIT_EXPENSE_TOOL\", \"GET_EXPENSE_TOOL\", \"GET_EMPLOYEE_TOOL\"],\n                        \"enable_human_tool\": \"true\"}',\n        description => 'Expense processing with human-in-the-loop'\n    );\nEND;\n/\n\nBEGIN\n    DBMS_CLOUD_AI_AGENT.CREATE_TEAM(\n        team_name   => 'EXPENSE_TEAM',\n        attributes  => '{\"agents\": [{\"name\": \"EXPENSE_AGENT\", \"task\": \"EXPENSE_TASK\"}],\n                        \"process\": \"sequential\"}',\n        description => 'Expense processing team'\n    );\nEND;\n/",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n### Task 5: Test the Complete Workflow\n\n1. Set the team.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nEXEC DBMS_CLOUD_AI_AGENT.SET_TEAM('EXPENSE_TEAM');",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. Test a small expense (auto-approve path).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $35 expense for supplies for employee EMP-002;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. Verify it was auto-approved - check the expense record.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT request_id, amount, category, status, approved_by\nFROM expense_requests\nORDER BY submitted_at DESC;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Observe:** Status is APPROVED and approved_by is AUTO - the $35 expense was auto-approved because it's under $50.\n\n4. Test a medium expense (standard path).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $200 expense for meals for employee EMP-003;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n5. Verify the medium expense status.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT request_id, amount, category, status, approved_by\nFROM expense_requests\nORDER BY submitted_at DESC\nFETCH FIRST 1 ROW ONLY;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Observe:** Status is PENDING - the $200 expense needs standard processing (not auto-approved, not blocked).\n\n6. Test a high-value expense (approval required path).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $1500 expense for training for employee EMP-002;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**The agent should NOT submit the expense.** It asks for your approval first.\n\n7. Decline the approval request.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT No, do not submit that expense;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\nThe agent acknowledges your decision and does not submit.\n\n8. Verify no $1500 expense was created.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT request_id, amount, category, status, approved_by\nFROM expense_requests\nORDER BY submitted_at DESC;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Observe:** The most recent expense should still be the $200 one - no $1500 training expense was created because you declined.\n\n9. Test a blocked expense.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $7500 expense for travel for employee EMP-001;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\nThe agent should check rules, see BLOCKED, and refuse to submit.\n\n10. Verify no $7500 expense was created.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT COUNT(*) as total_expenses FROM expense_requests;\nSELECT request_id, amount, status FROM expense_requests ORDER BY submitted_at DESC;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Observe:** No $7500 expense exists - the agent correctly blocked it.\n\n11. Test equipment (always needs approval regardless of amount).",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT Submit a $150 expense for equipment for employee EMP-002;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**The agent asks for approval** because equipment always requires it regardless of amount.\n\n12. Decline the equipment expense.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT AI AGENT No, decline that equipment purchase;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n13. Verify no equipment expense was created.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT request_id, amount, category, status, approved_by\nFROM expense_requests\nORDER BY submitted_at DESC;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n**Observe:** No equipment expense was created. You should only see the $35 supplies (APPROVED) and $200 meals (PENDING) expenses.\n\n---\n\n## Part 4: Audit Trail\n\nEverything the agent does is logged. This is essential for compliance and debugging.\n\n### Task 6: Query the Audit Trail\n\n1. See all tool calls.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT \n    tool_name,\n    TO_CHAR(start_date, 'HH24:MI:SS') as called,\n    SUBSTR(input, 1, 50) as input_preview,\n    SUBSTR(output, 1, 50) as output_preview\nFROM USER_AI_AGENT_TOOL_HISTORY\nORDER BY start_date DESC\nFETCH FIRST 15 ROWS ONLY;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n2. See the full input/output for recent calls.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT \n    tool_name,\n    TO_CHAR(start_date, 'YYYY-MM-DD HH24:MI:SS') as when,\n    input as full_input,\n    output as full_output\nFROM USER_AI_AGENT_TOOL_HISTORY\nWHERE start_date > SYSTIMESTAMP - INTERVAL '10' MINUTE\nORDER BY start_date;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n3. See all expense requests created with their status.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT \n    request_id,\n    (SELECT name FROM employees WHERE employee_id = e.employee_id) as employee,\n    amount,\n    category,\n    status,\n    NVL(approved_by, '-') as approved_by,\n    TO_CHAR(submitted_at, 'HH24:MI:SS') as submitted\nFROM expense_requests e\nORDER BY submitted_at DESC;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n4. Audit summary: tools used by type.",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nSELECT \n    tool_name,\n    COUNT(*) as call_count,\n    MIN(start_date) as first_call,\n    MAX(start_date) as last_call\nFROM USER_AI_AGENT_TOOL_HISTORY\nGROUP BY tool_name\nORDER BY call_count DESC;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    },
    {
      "text": "%md\n---\n\n## Summary\n\nIn this capstone lab, you built a complete agent system with:\n\n**Part 1: Tools**\n- PL/SQL functions that agents can call\n- Clean separation: LLM reasons, tools act\n- If there's no tool, the agent can't do it\n\n**Part 2: Safety Rules**\n- JSON-configured business rules\n- BLOCK / REQUIRE_APPROVAL / WARN / AUTO_APPROVE\n- Rules engine the agent calls before acting\n- Database constraints as the final backstop\n\n**Part 3: Human-in-the-Loop**\n- `enable_human_tool` for approval workflows\n- Agent genuinely pauses for human input\n- Collaboration spectrum: autonomous → supervised → collaborative\n\n**Part 4: Audit Trail**\n- Every tool call logged automatically\n- Full input/output captured\n- Explainable agent behavior\n\n**Key takeaway:** Agents are safe because their boundaries are explicit. Tools define capabilities. Rules define constraints. Humans retain control. Everything is auditable.\n\n## Learn More\n\n* [DBMS_CLOUD_AI_AGENT Package](https://docs.oracle.com/en/cloud/paas/autonomous-database/serverless/adbsb/dbms-cloud-ai-agent-package.html)\n* [Oracle Database Security Guide](https://docs.oracle.com/en/database/oracle/oracle-database/26/dbseg/)\n\n## Acknowledgements\n\n* **Author** - David Start\n* **Last Updated By/Date** - David Start, January 2026",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%md\n## Cleanup (Optional)",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "md" } }
    },
    {
      "text": "%script\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TEAM('EXPENSE_TEAM', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TASK('EXPENSE_TASK', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_AGENT('EXPENSE_AGENT', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('SUBMIT_EXPENSE_TOOL', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('CHECK_RULES_TOOL', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('GET_EXPENSE_TOOL', TRUE);\nEXEC DBMS_CLOUD_AI_AGENT.DROP_TOOL('GET_EMPLOYEE_TOOL', TRUE);\nDROP TABLE expense_requests PURGE;\nDROP TABLE employees PURGE;\nDROP TABLE safety_rules PURGE;\nDROP SEQUENCE expense_seq;\nDROP FUNCTION submit_expense;\nDROP FUNCTION get_expense_status;\nDROP FUNCTION get_employee_info;\nDROP FUNCTION check_expense_rules;",
      "config": { "colWidth": 12.0, "enabled": true, "results": {}, "editorSetting": { "language": "sql" } }
    }
  ],
  "name": "Lab 10 - Tools Safety Control",
  "id": "lab10-tools-safety-control",
  "noteParams": {},
  "noteForms": {},
  "angularObjects": {},
  "config": { "isZeppelinNotebookCronEnable": false },
  "info": {}
}